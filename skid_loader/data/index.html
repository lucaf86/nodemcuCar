<!DOCTYPE html>

<html>

<head>
    <meta name='viewport' content='width=device-width,         initial-scale=1.0,         user-scalable=no' />
    <meta charset="utf-8" />


    <title>Joystick and slider test</title>


    <style>
        #container {
            width: 100%;
            height: 49vh;
            background-color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 7px;
            touch-action: none;
        }

        #item {
            width: 100px;
            height: 100px;
            background-color: rgb(245, 230, 99);
            border: 10px solid rgba(136, 136, 136, .5);
            border-radius: 50%;
            touch-action: none;
            user-select: none;
        }

        #item:active {
            background-color: rgba(168, 218, 220, 1.00);
        }

        #item:hover {
            cursor: pointer;
            border-width: 20px;
        }

        #area {
            position: fixed;
            right: 0;
            top: 0;
        }
    </style>

    <script src="joy.js"></script>
    <script src="jquery-3.6.3.min.js"></script>
    <link href="roundslider.min.css" rel="stylesheet" />
    <script src="roundslider.min.js"></script>
</head>


<body>

    <div id="slider1"></div>
    <div id="slider1text">
        <div style="height: 10vh;"></div>
        Slider:<input id="slider1Value" type="text" /><br />    
    </div>
    
    <div id='outerContainer'>
        <div style="height: 40vh;"></div>
        <div id="joyDiv" style="width:200px;height:200px;margin:auto;"></div>
        
		Posizione X:<input id="joyPosizioneX" type="text" /><br />
		Posizione Y:<input id="joyPosizioneY" type="text" /><br />
		Direzione:<input id="joyDirezione" type="text" /><br />
		X :<input id="joyX" type="text" /><br />
		Y :<input id="joyY" type="text" /><br />
		PWM L :<input id="pwmL" type="text" /><br />
		PWM R :<input id="pwmR" type="text" />        
    </div>

    <script>


        const view = document.getElementById('stream');
        const WS_URL = "ws://" + window.location.host + ":82";
        //const WS_URL = 'ws://192.168.43.59:82';
        //const WS_URL = 'ws://192.168.1.76:82';
        console.log(WS_URL);
        const ws = new WebSocket(WS_URL);

        ws.onmessage = message => {
            if (message.data instanceof Blob) {
                var urlObject = URL.createObjectURL(message.data);
                view.src = urlObject;
            }
        };


        var lastText, lastSend, sendTimeout;
        // limit sending to one message every 30 ms
        // https://github.com/neonious/lowjs_esp32_examples/blob/master/neonious_one/cellphone_controlled_rc_car/www/index.html
        function send(txt) {
            var now = new Date().getTime();
            if (lastSend === undefined || now - lastSend >= 30) {
                try {
                    ws.send(txt);
                    lastSend = new Date().getTime();
                    return;
                } catch (e) {
                    console.log(e);
                }
            }
            lastText = txt;
            if (!sendTimeout) {
                var ms = lastSend !== undefined ? 30 - (now - lastSend) : 30;
                if (ms < 0)
                    ms = 0;
                sendTimeout = setTimeout(() => {
                    sendTimeout = null;
                    send(lastText);
                }, ms);
            }
        }

    </script>
</body>

<script type="text/javascript">

var slider1IinputVal = document.getElementById("slider1Value");

$("#slider1").roundSlider({
    svgMode: true,
    radius: 80,
    circleShape: "quarter-top-left",
    sliderType: "min-range",
    value: 0,
    update: "onSliderValueChange"
});

function onSliderValueChange (e) {
    console.log(e.value);
    slider1IinputVal.value = e.value;
    send("#L," + e.value);
}
  

    var joyIinputPosX = document.getElementById("joyPosizioneX");
    var joyInputPosY = document.getElementById("joyPosizioneY");
    var joyDirezione = document.getElementById("joyDirezione");
    var joyX = document.getElementById("joyX");
    var joyY = document.getElementById("joyY");
    var pwmL = document.getElementById("pwmL");
    var pwmR = document.getElementById("pwmR");

    // Create JoyStick object into the DIV 'joyDiv'
    var joy = new JoyStick('joyDiv', {}, function(stickData) {
    console.log("JOY callback executed");
    joyIinputPosX.value = stickData.xPosition;
    joyInputPosY.value = stickData.yPosition;
    joyDirezione.value = stickData.cardinalDirection;
    joyX.value = stickData.x;
    joyY.value = stickData.y;
});


    var inputPosX = document.getElementById("posizioneX");
    var inputPosY = document.getElementById("posizioneY");
    var direzione = document.getElementById("direzione");
    var fuerzaI = document.getElementById("fuerzaI");
    var fuerzaD = document.getElementById("fuerzaD");
    var x = document.getElementById("X");
    var y = document.getElementById("Y");




    //Steering control program, based on :
    // Differential Steering Joystick Algorithm
    //   by Calvin Hass
    //   https://www.impulseadventure.com/elec/

    function getfuerza(nJoyX, nJoyY) {
        var nMotMixL;
        var nMotMixR;
        var fPivYLimit = 32.0; //The threshold at which the pivot action starts
        //                This threshold is measured in units on the Y-axis
        //                away from the X-axis (Y=0). A greater value will assign
        //                more of the joystick's range to pivot actions
        //                Allowable range: 0 to 127

        // TEMP VARIABLES
        var nMotPremixL;    // Motor (left)  premixed output        (-128..+127)
        var nMotPremixR;    // Motor (right) premixed output        (-128..+127)
        var nPivSpeed;      // Pivot Speed                          (-128..+127)
        var fPivScale;       // Balance scale b/w drive and pivot    (   0..1   )

        // Calculate Drive Turn output due to Joystick X input
        if (nJoyY >= 0) {
            // Forward
            nMotPremixL = (nJoyX >= 0 ? 100.0 : 100.0 + parseFloat(nJoyX));
            nMotPremixR = (nJoyX >= 0 ? 100.0 - nJoyX : 100.0);
        } else {
            // Reverse
            nMotPremixL = (nJoyX >= 0 ? 100.0 - nJoyX : 100.0);
            nMotPremixR = (nJoyX >= 0 ? 100.0 : 100.0 + parseFloat(nJoyX));
        }

        // Scale Drive output due to Joystick Y input (throttle)
        nMotPremixL = nMotPremixL * nJoyY / 100.0;
        nMotPremixR = nMotPremixR * nJoyY / 100.0;

        // Now calculate pivot amount
        // - Strength of pivot (nPivSpeed) based on Joystick X input
        // - Blending of pivot vs drive (fPivScale) based on Joystick Y input
        nPivSpeed = nJoyX;
        fPivScale = (Math.abs(nJoyY) > fPivYLimit) ? 0.0 : (1.0 - Math.abs(nJoyY) / fPivYLimit);

        // Calculate final mix of Drive and Pivot
        nMotMixL = (1.0 - fPivScale) * nMotPremixL + fPivScale * (nPivSpeed);
        nMotMixR = (1.0 - fPivScale) * nMotPremixR + fPivScale * (-nPivSpeed);


      const pwmMultiplier = 2.55; 
        pwmL.value = Math.round(nMotMixL * pwmMultiplier);
        pwmR.value = Math.round(nMotMixR * pwmMultiplier);
    
        return "#M," + Math.round(nMotMixL * pwmMultiplier) + "," + Math.round(nMotMixR * pwmMultiplier);   // The function returns the product of p1 and p2
    }

   // setInterval(function () { send(getfuerza(joy.GetX(), joy.GetY())); }, 300);
    setInterval(function () { send(getfuerza(joy.GetX(), joy.GetY())); }, 50);

</script>

</ht���